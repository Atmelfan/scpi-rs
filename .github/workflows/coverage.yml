# Based on https://github.com/actions-rs/meta/blob/master/recipes/quickstart.md
#
# While our "example" application has the platform-specific code,
# for simplicity we are compiling and testing everything on the Ubuntu environment only.
# For multi-OS testing see the `cross.yml` workflow.

on: [push, pull_request]

name: Quickstart

jobs:
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install nightly toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly
          override: true

      - name: Coveralls GitHub Action
        uses: coverallsapp/github-action@v1.0.1

      - name: Run grcov
          env:
            PROJECT_NAME: "scpi"
            RUSTFLAGS: "-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-chec  ks=off -Zno-landing-pads"
            CARGO_INCREMENTAL: 0
          run: |
            cargo build --verbose --manifest-path=scpi/Cargo.toml
            cargo test --verbose --manifest-path=scpi/Cargo.toml
            zip -0 cov.zip $(find . -name "$PROJECT_NAME*.gc*" -print)
            grcov cov.zip -s . -t lcov --llvm --ignore-not-existing --ignore "/*" -o lcov.info

      - name: Push grcov results to Coveralls via GitHub Action
        uses: coverallsapp/github-action@v1.0.1
        with:
          github-token: ${{ secrets.COVERALLS_TOKEN }}
          path-to-lcov: "lcov.info"